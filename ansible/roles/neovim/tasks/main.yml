---
# Install Neovim via AppImage
- name: Neovimのセットアップ
  block:
    # 1. AppImageの実行に必要なFUSEライブラリをインストール
    # (Pop!_OSやUbuntu 22.04+ではデフォルトで入っていないことが多いため必須)
    - name: Install libfuse2 (Required for AppImage)
      apt:
        name: libfuse2
        state: present
      become: true

    # 2. 現在のバージョンを確認 (インストール済みの場合)
    - name: Check current Neovim version
      shell: "nvim --version | head -n 1 | awk '{print $2}'"
      register: nvim_current_version
      changed_when: false
      failed_when: false

    # 3. GitHub APIから最新のStableリリースの情報を取得
    - name: Get latest stable release info from GitHub
      uri:
        url: https://api.github.com/repos/neovim/neovim/releases/latest
        return_content: true
      register: nvim_latest_release

    # 4. バージョン比較とインストール
    # (ローカルが存在しない or ローカルとリモートのバージョンが不一致の場合に実行)
    - name: Download and install Neovim AppImage
      get_url:
        # 最新タグを使ってダウンロードURLを構築
        url: "https://github.com/neovim/neovim/releases/download/{{ nvim_latest_release.json.tag_name }}/nvim-linux-x86_64.appimage"
        dest: /usr/local/bin/nvim
        mode: '0755' # 実行権限を付与 (chmod u+x 相当)
        force: true  # バージョン違いなら上書きする
      become: true
      # 条件: 「Neovimが入っていない」 または 「バージョンが最新ではない」
      when: >
        nvim_current_version.rc != 0 or
        nvim_current_version.stdout != nvim_latest_release.json.tag_name

    - name: Display installed version
      debug:
        msg: "Neovim installed version: {{ nvim_latest_release.json.tag_name }}"

# Install AstroNvim
- name: Check if nvim config exists
  become: false
  stat:         # ファイルやディレクトリの状態を確認するモジュール (ls -l 的なもの)
    path: "{{ nvim_config_dir }}"
  register: nvim_config_stat # 結果を変数に保存

- name: Backup existing nvim config
  become: false
  command: "mv {{ nvim_config_dir }} {{ nvim_config_dir }}.bak.{{ ansible_date_time.iso8601 }}"
  when:         # 条件分岐
    - nvim_config_stat.stat.exists  # ディレクトリが存在する場合
    - not nvim_config_stat.stat.islnk # かつ、シンボリックリンクではない場合 (Git管理のリンク等を想定)

- name: Clone AstroNvim repository
  become: false
  git:          # git clone/pull を行うモジュール
    repo: "https://github.com/AstroNvim/template"
    dest: "{{ nvim_config_dir }}"
    version: main # ブランチ名
    depth: 1      # 最新コミットのみ取得（高速化・容量節約）

- name: rm useless .git in nvim config
  become: false
  file:
    path: "{{ nvim_config_dir }}/.git"
    state: absent

- name: Link nvim init.lua from dotfiles
  become: false
  file:
    src: "{{ ansible_env.HOME }}/dotfiles-popos/config/nvim/init.lua"
    dest: "{{ ansible_env.HOME }}/.config/nvim/init.lua"
    state: link
    force: true